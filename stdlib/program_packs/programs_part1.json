{
  "programs": [
    {
      "name": "CreateEntity",
      "description": "Create a new entity with guardian supervision",
      "inputs": [
        {"name": "entity_id", "type": "string", "required": true},
        {"name": "guardian_id", "type": "string", "required": true},
        {"name": "entity_type", "type": "string", "required": true},
        {"name": "name", "type": "string", "required": true}
      ],
      "context": [
        {"name": "guardian", "source": "ledger", "path": "entities.{guardian_id}"},
        {"name": "entity_type", "source": "input", "path": "entity_type"}
      ],
      "evaluate": "CHIP:create_entity",
      "on_allow": [
        {"type": "create", "entity_type": "entities", "id": {"type": "path", "path": ["input", "entity_id"]}, "data": {"type": "{entity_type}", "name": "{name}", "guardian": "{guardian_id}", "frozen": false, "balance": 0, "reputation": 0, "pending_obligations": 0, "completed_agreements": 0, "created_at": "{now}"}},
        {"type": "emit", "event": "entity_created", "data": {"id": "{entity_id}", "type": "{entity_type}"}}
      ],
      "on_deny": [{"type": "emit", "event": "entity_creation_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "FreezeEntity",
      "description": "Freeze an entity (guardian action)",
      "inputs": [
        {"name": "entity_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "entity", "source": "ledger", "path": "entities.{entity_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:freeze_entity",
      "on_allow": [
        {"type": "set", "target": "entities.{entity_id}.frozen", "value": {"type": "literal", "value": true}},
        {"type": "emit", "event": "entity_frozen", "data": {"id": "{entity_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "freeze_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "UnfreezeEntity",
      "description": "Unfreeze an entity (guardian action)",
      "inputs": [
        {"name": "entity_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "entity", "source": "ledger", "path": "entities.{entity_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:unfreeze_entity",
      "on_allow": [
        {"type": "set", "target": "entities.{entity_id}.frozen", "value": {"type": "literal", "value": false}},
        {"type": "emit", "event": "entity_unfrozen", "data": {"id": "{entity_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "unfreeze_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "BindGuardian",
      "description": "Bind a guardian to an agent",
      "inputs": [
        {"name": "agent_id", "type": "string", "required": true},
        {"name": "guardian_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agent", "source": "ledger", "path": "entities.{agent_id}"},
        {"name": "guardian", "source": "ledger", "path": "entities.{guardian_id}"}
      ],
      "evaluate": "CHIP:bind_guardian",
      "on_allow": [
        {"type": "set", "target": "entities.{agent_id}.guardian", "value": {"type": "literal", "value": "{guardian_id}"}},
        {"type": "increment", "target": "entities.{guardian_id}.bound_count", "amount": {"type": "literal", "value": 1}},
        {"type": "emit", "event": "guardian_bound", "data": {"agent": "{agent_id}", "guardian": "{guardian_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "binding_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "UnbindGuardian",
      "description": "Unbind guardian from agent (freezes agent)",
      "inputs": [
        {"name": "agent_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agent", "source": "ledger", "path": "entities.{agent_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:unbind_guardian",
      "on_allow": [
        {"type": "set", "target": "entities.{agent_id}.guardian", "value": {"type": "literal", "value": null}},
        {"type": "set", "target": "entities.{agent_id}.frozen", "value": {"type": "literal", "value": true}},
        {"type": "emit", "event": "guardian_unbound", "data": {"agent": "{agent_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "unbinding_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "TransferGuardianship",
      "description": "Transfer guardianship to a new guardian",
      "inputs": [
        {"name": "agent_id", "type": "string", "required": true},
        {"name": "new_guardian_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agent", "source": "ledger", "path": "entities.{agent_id}"},
        {"name": "new_guardian", "source": "ledger", "path": "entities.{new_guardian_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:transfer_guardianship",
      "on_allow": [
        {"type": "set", "target": "entities.{agent_id}.guardian", "value": {"type": "literal", "value": "{new_guardian_id}"}},
        {"type": "increment", "target": "entities.{new_guardian_id}.bound_count", "amount": {"type": "literal", "value": 1}},
        {"type": "emit", "event": "guardianship_transferred", "data": {"agent": "{agent_id}", "to": "{new_guardian_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "transfer_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "ProposeAgreement",
      "description": "Propose a new agreement between parties",
      "inputs": [
        {"name": "agreement_id", "type": "string", "required": true},
        {"name": "proposer_id", "type": "string", "required": true},
        {"name": "party_ids", "type": "array", "required": true},
        {"name": "terms", "type": "object", "required": true}
      ],
      "context": [
        {"name": "proposer", "source": "ledger", "path": "entities.{proposer_id}"},
        {"name": "proposer_id", "source": "input", "path": "proposer_id"},
        {"name": "party_ids", "source": "input", "path": "party_ids"}
      ],
      "evaluate": "CHIP:propose_agreement",
      "on_allow": [
        {"type": "create", "entity_type": "agreements", "id": {"type": "path", "path": ["input", "agreement_id"]}, "data": {"parties": "{party_ids}", "terms": "{terms}", "status": "proposed", "signatures": ["{proposer_id}"], "pending_obligations": 0, "created_at": "{now}"}},
        {"type": "emit", "event": "agreement_proposed", "data": {"id": "{agreement_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "proposal_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "SignAgreement",
      "description": "Sign an agreement",
      "inputs": [
        {"name": "agreement_id", "type": "string", "required": true},
        {"name": "signer_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"},
        {"name": "signer_id", "source": "input", "path": "signer_id"}
      ],
      "evaluate": "CHIP:sign_agreement",
      "on_allow": [
        {"type": "append", "target": "agreements.{agreement_id}.signatures", "value": {"type": "path", "path": ["input", "signer_id"]}},
        {"type": "emit", "event": "agreement_signed", "data": {"id": "{agreement_id}", "by": "{signer_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "signing_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "ActivateAgreement",
      "description": "Activate an agreement after all signatures",
      "inputs": [{"name": "agreement_id", "type": "string", "required": true}],
      "context": [{"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"}],
      "evaluate": "CHIP:activate_agreement",
      "on_allow": [
        {"type": "set", "target": "agreements.{agreement_id}.status", "value": {"type": "literal", "value": "active"}},
        {"type": "emit", "event": "agreement_activated", "data": {"id": "{agreement_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "activation_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "CompleteAgreement",
      "description": "Complete an agreement after all obligations fulfilled",
      "inputs": [{"name": "agreement_id", "type": "string", "required": true}],
      "context": [{"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"}],
      "evaluate": "CHIP:complete_agreement",
      "on_allow": [
        {"type": "set", "target": "agreements.{agreement_id}.status", "value": {"type": "literal", "value": "completed"}},
        {"type": "emit", "event": "agreement_completed", "data": {"id": "{agreement_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "completion_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "TerminateAgreement",
      "description": "Terminate an agreement",
      "inputs": [
        {"name": "agreement_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true},
        {"name": "reason", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:terminate_agreement",
      "on_allow": [
        {"type": "set", "target": "agreements.{agreement_id}.status", "value": {"type": "literal", "value": "terminated"}},
        {"type": "emit", "event": "agreement_terminated", "data": {"id": "{agreement_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "termination_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "DisputeAgreement",
      "description": "Dispute an active agreement",
      "inputs": [
        {"name": "agreement_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true},
        {"name": "reason", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:dispute_agreement",
      "on_allow": [
        {"type": "set", "target": "agreements.{agreement_id}.status", "value": {"type": "literal", "value": "disputed"}},
        {"type": "emit", "event": "agreement_disputed", "data": {"id": "{agreement_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "dispute_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "CreateObligation",
      "description": "Create an obligation under an agreement",
      "inputs": [
        {"name": "obligation_id", "type": "string", "required": true},
        {"name": "agreement_id", "type": "string", "required": true},
        {"name": "debtor_id", "type": "string", "required": true},
        {"name": "creditor_id", "type": "string", "required": true},
        {"name": "description", "type": "string", "required": true}
      ],
      "context": [
        {"name": "agreement", "source": "ledger", "path": "agreements.{agreement_id}"},
        {"name": "debtor_id", "source": "input", "path": "debtor_id"}
      ],
      "evaluate": "CHIP:create_obligation",
      "on_allow": [
        {"type": "create", "entity_type": "obligations", "id": {"type": "path", "path": ["input", "obligation_id"]}, "data": {"agreement_id": "{agreement_id}", "debtor": "{debtor_id}", "creditor": "{creditor_id}", "description": "{description}", "status": "pending", "created_at": "{now}"}},
        {"type": "increment", "target": "agreements.{agreement_id}.pending_obligations", "amount": {"type": "literal", "value": 1}},
        {"type": "increment", "target": "entities.{debtor_id}.pending_obligations", "amount": {"type": "literal", "value": 1}},
        {"type": "emit", "event": "obligation_created", "data": {"id": "{obligation_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "obligation_creation_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "FulfillObligation",
      "description": "Fulfill an obligation",
      "inputs": [
        {"name": "obligation_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true},
        {"name": "evidence", "type": "object", "required": true}
      ],
      "context": [
        {"name": "obligation", "source": "ledger", "path": "obligations.{obligation_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:fulfill_obligation",
      "on_allow": [
        {"type": "set", "target": "obligations.{obligation_id}.status", "value": {"type": "literal", "value": "fulfilled"}},
        {"type": "decrement", "target": "entities.{obligation.debtor}.pending_obligations", "amount": {"type": "literal", "value": 1}},
        {"type": "increment", "target": "entities.{obligation.debtor}.completed_agreements", "amount": {"type": "literal", "value": 1}},
        {"type": "emit", "event": "obligation_fulfilled", "data": {"id": "{obligation_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "fulfillment_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "VerifyFulfillment",
      "description": "Verify obligation fulfillment",
      "inputs": [
        {"name": "obligation_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true},
        {"name": "approved", "type": "boolean", "required": true}
      ],
      "context": [
        {"name": "obligation", "source": "ledger", "path": "obligations.{obligation_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:verify_fulfillment",
      "on_allow": [
        {"type": "set", "target": "obligations.{obligation_id}.verified", "value": {"type": "literal", "value": true}},
        {"type": "emit", "event": "fulfillment_verified", "data": {"id": "{obligation_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "verification_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "DisputeObligation",
      "description": "Dispute an obligation",
      "inputs": [
        {"name": "obligation_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true},
        {"name": "reason", "type": "string", "required": true}
      ],
      "context": [
        {"name": "obligation", "source": "ledger", "path": "obligations.{obligation_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:dispute_obligation",
      "on_allow": [
        {"type": "set", "target": "obligations.{obligation_id}.status", "value": {"type": "literal", "value": "disputed"}},
        {"type": "emit", "event": "obligation_disputed", "data": {"id": "{obligation_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "dispute_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "CreateWallet",
      "description": "Create a wallet for an entity",
      "inputs": [
        {"name": "wallet_id", "type": "string", "required": true},
        {"name": "owner_id", "type": "string", "required": true}
      ],
      "context": [{"name": "owner", "source": "ledger", "path": "entities.{owner_id}"}],
      "evaluate": "CHIP:create_wallet",
      "on_allow": [
        {"type": "create", "entity_type": "wallets", "id": {"type": "path", "path": ["input", "wallet_id"]}, "data": {"owner": "{owner_id}", "balance": 0, "frozen": false, "created_at": "{now}"}},
        {"type": "emit", "event": "wallet_created", "data": {"id": "{wallet_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "wallet_creation_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "Transfer",
      "description": "Transfer funds between entities",
      "inputs": [
        {"name": "from", "type": "string", "required": true},
        {"name": "to", "type": "string", "required": true},
        {"name": "amount", "type": "number", "required": true}
      ],
      "context": [
        {"name": "sender", "source": "ledger", "path": "entities.{from}"},
        {"name": "recipient", "source": "ledger", "path": "entities.{to}"},
        {"name": "amount", "source": "input", "path": "amount"}
      ],
      "evaluate": "CHIP:transfer",
      "on_allow": [
        {"type": "decrement", "target": "entities.{from}.balance", "amount": {"type": "path", "path": ["amount"]}},
        {"type": "increment", "target": "entities.{to}.balance", "amount": {"type": "path", "path": ["amount"]}},
        {"type": "emit", "event": "transfer_completed", "data": {"from": "{from}", "to": "{to}", "amount": "{amount}"}}
      ],
      "on_deny": [{"type": "emit", "event": "transfer_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "TransferWithApproval",
      "description": "Transfer with guardian approval",
      "inputs": [
        {"name": "from", "type": "string", "required": true},
        {"name": "to", "type": "string", "required": true},
        {"name": "amount", "type": "number", "required": true},
        {"name": "guardian_signature", "type": "boolean", "required": true}
      ],
      "context": [
        {"name": "sender", "source": "ledger", "path": "entities.{from}"},
        {"name": "amount", "source": "input", "path": "amount"},
        {"name": "guardian_signature", "source": "input", "path": "guardian_signature"}
      ],
      "evaluate": "CHIP:transfer_with_approval",
      "on_allow": [
        {"type": "decrement", "target": "entities.{from}.balance", "amount": {"type": "path", "path": ["amount"]}},
        {"type": "increment", "target": "entities.{to}.balance", "amount": {"type": "path", "path": ["amount"]}},
        {"type": "emit", "event": "approved_transfer", "data": {"from": "{from}", "to": "{to}"}}
      ],
      "on_deny": [{"type": "emit", "event": "approved_transfer_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "FreezeWallet",
      "description": "Freeze a wallet (guardian action)",
      "inputs": [
        {"name": "wallet_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "wallet", "source": "ledger", "path": "wallets.{wallet_id}"},
        {"name": "wallet_owner", "source": "ledger", "path": "entities.{wallet.owner}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:freeze_wallet",
      "on_allow": [
        {"type": "set", "target": "wallets.{wallet_id}.frozen", "value": {"type": "literal", "value": true}},
        {"type": "emit", "event": "wallet_frozen", "data": {"id": "{wallet_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "wallet_freeze_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "CreateEscrow",
      "description": "Create and fund an escrow",
      "inputs": [
        {"name": "escrow_id", "type": "string", "required": true},
        {"name": "buyer_id", "type": "string", "required": true},
        {"name": "seller_id", "type": "string", "required": true},
        {"name": "amount", "type": "number", "required": true}
      ],
      "context": [
        {"name": "buyer", "source": "ledger", "path": "entities.{buyer_id}"},
        {"name": "seller", "source": "ledger", "path": "entities.{seller_id}"},
        {"name": "amount", "source": "input", "path": "amount"}
      ],
      "evaluate": "CHIP:create_escrow",
      "on_allow": [
        {"type": "decrement", "target": "entities.{buyer_id}.balance", "amount": {"type": "path", "path": ["amount"]}},
        {"type": "create", "entity_type": "escrows", "id": {"type": "path", "path": ["input", "escrow_id"]}, "data": {"buyer": "{buyer_id}", "seller": "{seller_id}", "amount": "{amount}", "status": "funded", "created_at": "{now}"}},
        {"type": "emit", "event": "escrow_created", "data": {"id": "{escrow_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "escrow_creation_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "FundEscrow",
      "description": "Fund a created escrow",
      "inputs": [
        {"name": "escrow_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "escrow", "source": "ledger", "path": "escrows.{escrow_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:fund_escrow",
      "on_allow": [
        {"type": "set", "target": "escrows.{escrow_id}.status", "value": {"type": "literal", "value": "funded"}},
        {"type": "emit", "event": "escrow_funded", "data": {"id": "{escrow_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "escrow_funding_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "ReleaseEscrow",
      "description": "Release escrow funds to seller",
      "inputs": [
        {"name": "escrow_id", "type": "string", "required": true},
        {"name": "caller_id", "type": "string", "required": true}
      ],
      "context": [
        {"name": "escrow", "source": "ledger", "path": "escrows.{escrow_id}"},
        {"name": "caller_id", "source": "input", "path": "caller_id"}
      ],
      "evaluate": "CHIP:release_escrow",
      "on_allow": [
        {"type": "increment", "target": "entities.{escrow.seller}.balance", "amount": {"type": "path", "path": ["escrow", "amount"]}},
        {"type": "set", "target": "escrows.{escrow_id}.status", "value": {"type": "literal", "value": "released"}},
        {"type": "emit", "event": "escrow_released", "data": {"id": "{escrow_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "escrow_release_denied", "data": {"reason": "{proof.failed_gates}"}}]
    },
    {
      "name": "RefundEscrow",
      "description": "Refund escrow to buyer",
      "inputs": [
        {"name": "escrow_id", "type": "string", "required": true},
        {"name": "seller_failed", "type": "boolean", "required": true}
      ],
      "context": [
        {"name": "escrow", "source": "ledger", "path": "escrows.{escrow_id}"},
        {"name": "seller_failed", "source": "input", "path": "seller_failed"}
      ],
      "evaluate": "CHIP:refund_escrow",
      "on_allow": [
        {"type": "increment", "target": "entities.{escrow.buyer}.balance", "amount": {"type": "path", "path": ["escrow", "amount"]}},
        {"type": "set", "target": "escrows.{escrow_id}.status", "value": {"type": "literal", "value": "refunded"}},
        {"type": "emit", "event": "escrow_refunded", "data": {"id": "{escrow_id}"}}
      ],
      "on_deny": [{"type": "emit", "event": "escrow_refund_denied", "data": {"reason": "{proof.failed_gates}"}}]
    }
  ]
}
